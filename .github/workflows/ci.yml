name: RANKAK AI Engine - CI Pipeline

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

env:
  RANKAK_VERSION: "1.0.0"

jobs:
  # ============================================
  # JOB 1: Algorithm Unit Tests
  # ============================================
  algorithm-tests:
    name: ðŸ§  Algorithm Tests
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        python-version: ['3.10', '3.11']
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
      
      - name: Cache pip dependencies
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r cr-v4-backend/requirements.txt
      
      # ============================================
      # LAYER 3: Academic Calendar Tests (4 tests)
      # ============================================
      - name: Test Academic Calendar Engine
        run: |
          cd cr-v4-backend
          python -c "
          from app.engine.algorithms.academic_calendar import run_all_tests
          run_all_tests()
          print('âœ… Academic Calendar: 4 tests passed')
          "
      
      # ============================================
      # LAYER 4: Concept Reveal Tests (4 tests)
      # ============================================
      - name: Test Concept Reveal Engine
        run: |
          cd cr-v4-backend
          python -c "
          from app.engine.algorithms.concept_reveal import run_all_tests
          run_all_tests()
          print('âœ… Concept Reveal: 4 tests passed')
          "
      
      # ============================================
      # LAYER 5: Bayesian Learning Tests (5 tests)
      # ============================================
      - name: Test Bayesian Learning
        run: |
          cd cr-v4-backend
          python -c "
          from app.engine.algorithms.bayesian_learning import run_all_tests
          run_all_tests()
          print('âœ… Bayesian Learning: 5 tests passed')
          "
      
      # ============================================
      # LAYER 5: Knowledge State Tests (6 tests)
      # ============================================
      - name: Test Knowledge State Tracker
        run: |
          cd cr-v4-backend
          python -c "
          from app.engine.algorithms.knowledge_state import run_all_tests
          run_all_tests()
          print('âœ… Knowledge State: 6 tests passed')
          "
      
      # ============================================
      # LAYER 6: IRT Model Tests (4 tests)
      # ============================================
      - name: Test IRT Model
        run: |
          cd cr-v4-backend
          python -c "
          from app.engine.algorithms.irt_model import run_all_tests
          run_all_tests()
          print('âœ… IRT Model: 4 tests passed')
          "
      
      # ============================================
      # LAYER 6: Question Selector Tests (4 tests)
      # ============================================
      - name: Test Question Selector
        run: |
          cd cr-v4-backend
          python -c "
          from app.engine.algorithms.question_selector import run_all_tests
          run_all_tests()
          print('âœ… Question Selector: 4 tests passed')
          "
      
      # ============================================
      # LAYER 7: Root Cause Analyzer Tests (5 tests)
      # ============================================
      - name: Test Root Cause Analyzer
        run: |
          cd cr-v4-backend
          python -c "
          from app.engine.algorithms.root_cause_analyzer import run_all_tests
          run_all_tests()
          print('âœ… Root Cause Analyzer: 5 tests passed')
          "
      
      # ============================================
      # LAYER 9: Engagement Manager Tests (5 tests)
      # ============================================
      - name: Test Engagement Manager
        run: |
          cd cr-v4-backend
          python -c "
          from app.engine.algorithms.engagement_manager import run_all_tests
          run_all_tests()
          print('âœ… Engagement Manager: 5 tests passed')
          "
      
      # ============================================
      # LAYER 10: Psychology Engine Tests (5 tests)
      # ============================================
      - name: Test Psychology Engine
        run: |
          cd cr-v4-backend
          python -c "
          from app.engine.algorithms.psychology_engine import run_all_tests
          run_all_tests()
          print('âœ… Psychology Engine: 5 tests passed')
          "
      
      # ============================================
      # TEST MANAGER Tests (5 tests)
      # ============================================
      - name: Test Test Manager
        run: |
          cd cr-v4-backend
          python -c "
          from app.engine.algorithms.test_manager import run_all_tests
          run_all_tests()
          print('âœ… Test Manager: 5 tests passed')
          "
      
      # ============================================
      # IMPORT VERIFICATION
      # ============================================
      - name: Verify All Module Imports
        run: |
          cd cr-v4-backend
          python -c "
          from app.engine.algorithms import (
              # Core
              bayes_update_mastery,
              irt_probability,
              fisher_information,
              # Knowledge
              KnowledgeStateTracker,
              StudentKnowledgeState,
              # Selection
              QuestionSelector,
              # Calendar
              AcademicCalendarEngine,
              StudentPhase,
              # Reveal
              ConceptRevealEngine,
              # New Phase 3
              EngagementManager,
              RootCauseAnalyzer,
              PsychologyEngine,
              TestManager,
          )
          print('âœ… All algorithm module imports successful')
          "

  # ============================================
  # JOB 2: RANKAK Simulation System Tests
  # ============================================
  simulation-tests:
    name: ðŸŽ¯ RANKAK Simulation Tests
    runs-on: ubuntu-latest
    needs: algorithm-tests
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install simulation dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r cr-v4-backend/requirements.txt
          pip install pyarrow
      
      # ============================================
      # SIMULATION MODULE IMPORTS
      # ============================================
      - name: Verify Simulation Module Imports
        run: |
          cd cr-v4-backend
          python -c "
          from simulation.config import SimulationConfig, PersonaType, TimeConfig
          from simulation.agents.genome import StudentGenome, GenomeFactory
          from simulation.agents.cognitive_core import CognitiveLogicCore
          from simulation.agents.trust_engine import TrustEngine
          from simulation.orchestrator.main import SimulationOrchestrator
          from simulation.orchestrator.time_keeper import TimeKeeper
          from simulation.observer.god_view import GodViewObserver
          from simulation.data.storage import DataWriter
          print('âœ… All RANKAK simulation modules imported successfully')
          "
      
      # ============================================
      # GENOME FACTORY TESTS
      # ============================================
      - name: Test Genome Factory
        run: |
          cd cr-v4-backend
          python -c "
          from simulation.agents.genome import GenomeFactory, PersonaType
          from datetime import date
          
          factory = GenomeFactory()
          genome = factory.create_genome(
              persona=PersonaType.STEADY_LEARNER,
              standard=11,
              target_exam_date=date(2026, 1, 20)
          )
          assert genome.persona_type == PersonaType.STEADY_LEARNER
          assert genome.standard == 11
          print('âœ… Genome Factory: Tests passed')
          "
      
      # ============================================
      # COGNITIVE CORE TESTS
      # ============================================
      - name: Test Cognitive Logic Core
        run: |
          cd cr-v4-backend
          python -c "
          from simulation.agents.cognitive_core import CognitiveLogicCore
          
          clc = CognitiveLogicCore()
          prob = clc._irt_probability(0.5, 1.0, 0.0, 0.25)
          assert 0.0 <= prob <= 1.0, 'IRT probability out of bounds'
          print('âœ… Cognitive Logic Core: Tests passed')
          "
      
      # ============================================
      # TRUST ENGINE TESTS
      # ============================================
      - name: Test Trust Engine
        run: |
          cd cr-v4-backend
          python -c "
          from simulation.agents.trust_engine import TrustEngine, TrustZone
          from simulation.config import TrustConfig
          
          config = TrustConfig()
          engine = TrustEngine(config)
          assert engine.state.zone == TrustZone.HIGH
          print('âœ… Trust Engine: Tests passed')
          "
      
      # ============================================
      # TIME KEEPER TESTS
      # ============================================
      - name: Test Time Keeper
        run: |
          cd cr-v4-backend
          python -c "
          from simulation.orchestrator.time_keeper import TimeKeeper
          from datetime import datetime
          
          keeper = TimeKeeper(compression_ratio=100.0)
          assert keeper.compression_ratio == 100.0
          print('âœ… Time Keeper: Tests passed')
          "
      
      # ============================================
      # PARQUET STORAGE TESTS
      # ============================================
      - name: Test Parquet Storage
        run: |
          cd cr-v4-backend
          python -c "
          from simulation.data.storage import DataWriter
          
          writer = DataWriter(batch_size=100)
          assert writer.batch_size == 100
          print('âœ… Parquet Storage: Tests passed')
          "
      
      # ============================================
      # 8 PERSONA TYPES VALIDATION
      # ============================================
      - name: Validate 8 Persona Types
        run: |
          cd cr-v4-backend
          python -c "
          from simulation.config import PersonaType
          
          personas = list(PersonaType)
          assert len(personas) == 8, f'Expected 8 personas, got {len(personas)}'
          
          expected = [
              'STRUGGLING_PERSISTER',
              'ANXIOUS_PERFECTIONIST', 
              'DISENGAGED_GAMER',
              'CONCEPTUALLY_GAPPED',
              'STEADY_LEARNER',
              'FAST_TRACKER',
              'LATE_JOINER',
              'DROPPER'
          ]
          for name in expected:
              assert hasattr(PersonaType, name), f'Missing persona: {name}'
          
          print('âœ… All 8 Persona Types validated')
          "
      
      # ============================================
      # MINI SIMULATION RUN
      # ============================================
      - name: Run Mini Simulation (10 agents, 50 steps)
        run: |
          cd cr-v4-backend
          python -c "
          from simulation.orchestrator.main import SimulationOrchestrator
          from simulation.config import SimulationConfig, TimeConfig
          from datetime import date
          
          config = SimulationConfig(
              time=TimeConfig(compression_ratio=1000.0)
          )
          
          orchestrator = SimulationOrchestrator(config=config)
          orchestrator.initialize(
              agent_count=10,
              target_exam_date=date(2026, 1, 20)
          )
          
          metrics = orchestrator.run(max_steps=50)
          
          assert metrics.standard_violations == 0, 'Standard violations detected!'
          print(f'âœ… Mini Simulation: {orchestrator.interactions_count} interactions, 0 violations')
          "

  # ============================================
  # JOB 3: Final Summary
  # ============================================
  summary:
    name: ðŸ“Š Pipeline Summary
    runs-on: ubuntu-latest
    needs: [algorithm-tests, simulation-tests]
    
    steps:
      - name: RANKAK CI Pipeline Complete
        run: |
          echo "======================================================"
          echo "   ðŸš€ RANKAK AI ENGINE - CI PIPELINE COMPLETE"
          echo "======================================================"
          echo ""
          echo "   Version: ${{ env.RANKAK_VERSION }}"
          echo ""
          echo "   âœ… Algorithm Tests:"
          echo "      - Academic Calendar: 4 tests"
          echo "      - Concept Reveal: 4 tests"
          echo "      - Bayesian Learning: 5 tests"
          echo "      - Knowledge State: 6 tests"
          echo "      - IRT Model: 4 tests"
          echo "      - Question Selector: 4 tests"
          echo "      - Root Cause Analyzer: 5 tests"
          echo "      - Engagement Manager: 5 tests"
          echo "      - Psychology Engine: 5 tests"
          echo "      - Test Manager: 5 tests"
          echo ""
          echo "   âœ… Simulation Tests:"
          echo "      - Module Imports: Verified"
          echo "      - Genome Factory: Passed"
          echo "      - Cognitive Core: Passed"
          echo "      - Trust Engine: Passed"
          echo "      - Time Keeper: Passed"
          echo "      - Parquet Storage: Passed"
          echo "      - 8 Personas: Validated"
          echo "      - Mini Simulation: 0 violations"
          echo ""
          echo "======================================================"
          echo "   TOTAL: 47+ Algorithm + 8 Simulation Tests"
          echo "======================================================"

